image: mcr.microsoft.com/dotnet/sdk:9.0

stages:
  - build
  - test
  # - code_style # ?????? ???????, ???? ????????

variables:
  # ????? ?? ?????? ???????? ???????? ?????? ???????????
  SOLUTION_FILE: "Assessment.sln"
  SESSION_MVC_PROJECT_PATH: "sessionMVC/sessionMVC.csproj" # ???? ?? ????????? ???????
  TEST_PROJECT_PATH: "Session.UnitTests/Session.UnitTests.csproj" # ???? ?? ????????? ???????

before_script:
  - echo "Using .NET SDK $(dotnet --version)"
  - dotnet --info # ?????? ???????? ?????????? ??? SDK

build_solution:
  stage: build
  script:
    - echo "Restoring NuGet packages for solution ${SOLUTION_FILE}..."
    - dotnet restore "${SOLUTION_FILE}"
    - echo "Building solution ${SOLUTION_FILE} in Release configuration..."
    - dotnet build "${SOLUTION_FILE}" --configuration Release --no-restore
  artifacts:
    paths:
      # ?????????? ????????? ??????, ???? ???? ???????? ??? ????????? ?????? ??? ??? ????????????
      # ?????????, ??? sessionMVC:
      - sessionMVC/bin/Release/
      - sessionMVC/obj/Release/ # ???????, ?? ???????? ??? obj, ??? ???? ???? ????????
    expire_in: 1 hour

run_tests:
  stage: test
  needs: [build_solution] # ????????? ?????? ????? ???????? ??????
  script:
    - echo "Running tests for ${TEST_PROJECT_PATH}..."
    # --no-build, ???????? ?? ??? ??????? ??? ?? ????? build_solution
    - dotnet test "${TEST_PROJECT_PATH}" --configuration Release --no-build --logger "trx;LogFileName=test_results.trx"
  artifacts:
    when: always # ??????? ????? ??? ????? ??????
    reports:
      junit: "${TEST_PROJECT_PATH}/TestResults/test_results.trx" # ???? ???????? ?????? ???????
      # GitLab ??????????? ????????? TRX ? ?????? JUnit ??? ???????????? ? UI